<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="top">
        <input type="text" placeholder="Your Name" id="name"><br>
    </div>
    <div id="conversation">
    </div>
    <div id="send">
        <input type="text" placeholder="type here" id="message">
        <button onclick="sendMessageFromClient()" id="send">Send</button>
    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

<script>
    let uuidv4
    try {
        uuidv4 = JSON.parse(localStorage.getItem("sessions")).uuidv4
    } catch {}
    document.getElementById("message").addEventListener("keyup", (event) => {
        if (event.keyCode === 13) {
            event.preventDefault()
            sendMessageFromClient()
        }
    })
    const sendMessageFromClient = () => {
        const message = document.getElementById("message").value
        const name = document.getElementById("name").value
        const messageItem = document.createElement("li")
        const messageObject = {
            message,
            name
        }

        messageItem.innerHTML = messageObject.message
        document.getElementById("conversation").appendChild(messageItem)
        document.getElementById("message").value = ""

        socket.send(JSON.stringify({
            ...messageObject,
            type:"message",
            uuidv4,
        }))
    }
</script>

<script>
    let socket
    if(window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"){
        socket = new WebSocket("ws://localhost:9000")
    } else{
        socket = new WebSocket("ws://alexandrotapia.ml:9000")
    }
    console.log("Attempting Connection...")

    socket.onopen = event => console.log("Successfully Connected:", event)
    socket.onclose = event => console.log("Socket Closed Connection:", event)
    socket.onerror = error => console.log("Socket Closed Connection:", error)
    socket.onmessage = (message) => {
        try {
            const messageObject = JSON.parse(message.data)
            console.log(messageObject)
            if(messageObject.type === "message" || messageObject.type === "botMessage"){ //handle message
                const messageItem = document.createElement("li")
                messageItem.innerHTML = messageObject.message
                document.getElementById("conversation").appendChild(messageItem)
                document.getElementById("message").value = ""
            }
            else if(messageObject.type === "first"){ //handle ping session
                if(!uuidv4){
                    uuidv4 = messageObject.uuidv4
                    localStorage.setItem("sessions",JSON.stringify({
                        uuidv4
                    }))
                    socket.send(JSON.stringify({
                        type : "register",
                        message : "register new visitor",
                        uuidv4
                    }))
                }
                else{
                    socket.send(JSON.stringify({
                        type : "visitor",
                        message : "existing visitor",
                        uuidv4
                    }))
                }
            }
        } catch (error) {console.error(error)}
    }

</script>